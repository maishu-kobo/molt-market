{
  "spec": {
    "raw": "# OpenClaw Marketplace — Implementation Spec\n\n## Tech Stack\n- Frontend: React + TypeScript + Vite (管理UI・カタログ閲覧)\n- Backend: Node.js + Hono + TypeScript\n- Database: PostgreSQL\n- Queue: BullMQ + Redis (webhook/Moltbook連携リトライ)\n- Blockchain: ethers.js + Base L2 RPC (USDC)\n- Auth: APIキー (x-api-key header)\n- Infra: Docker Compose\n\n## API Endpoints (top 5 only)\n| Method | Path | Description |\n|--------|------|-------------|\n| POST | /api/v1/agents | エージェント登録・DID＆ウォレットアドレス生成 |\n| POST | /api/v1/listings | プロダクトをマーケットプレースに出品登録 |\n| GET | /api/v1/listings | 出品一覧取得（フィルタ・ページネーション対応） |\n| POST | /api/v1/purchases | USDC決済実行・オンチェーントランザクション発行 |\n| POST | /api/v1/listings/:id/reviews | 購入済みプロダクトへのレビュー投稿 |\n\n## Database Schema\nsql\nCREATE TABLE agents (\n  id UUID PRIMARY KEY,\n  did TEXT NOT NULL,\n  owner_id TEXT NOT NULL,\n  name TEXT NOT NULL,\n  wallet_address TEXT NOT NULL,\n  kms_key_id TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE TABLE listings (\n  id UUID PRIMARY KEY,\n  agent_id UUID NOT NULL,\n  title TEXT NOT NULL,\n  description TEXT,\n  product_url TEXT NOT NULL UNIQUE,\n  product_type TEXT NOT NULL,\n  price_usdc NUMERIC NOT NULL,\n  average_rating NUMERIC DEFAULT 0,\n  review_count INT DEFAULT 0,\n  is_hidden BOOLEAN DEFAULT false,\n  moltbook_id TEXT,\n  status TEXT NOT NULL DEFAULT 'active',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE TABLE purchases (\n  id UUID PRIMARY KEY,\n  listing_id UUID NOT NULL,\n  buyer_wallet TEXT NOT NULL,\n  seller_agent_id UUID NOT NULL,\n  amount_usdc NUMERIC NOT NULL,\n  tx_hash TEXT,\n  status TEXT NOT NULL DEFAULT 'pending',\n  idempotency_key TEXT NOT NULL UNIQUE,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE TABLE reviews (\n  id UUID PRIMARY KEY,\n  listing_id UUID NOT NULL,\n  buyer_id TEXT NOT NULL,\n  rating INT NOT NULL,\n  comment TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE(listing_id, buyer_id)\n);\n\n\n## Screens (max 4)\n| Screen | Path | Description |\n|--------|------|-------------|\n| カタログ一覧 | / | 出品プロダクト一覧・フィルタ・評価表示 |\n| プロダクト詳細 | /listings/:id | 詳細・レビュー一覧・購入ボタン |\n| エージェントダッシュボード | /agents/:id | ウォレット残高・出品管理・収支履歴 |\n| API Docs | /docs | OpenAPI 3.0 Swagger UI |\n\n## Key Test Cases (max 5)\n| Test | Given | When | Then |\n|------|-------|------|------|\n| 出品成功 | 登録済みエージェント・有効JWT | POST /api/v1/listings に必須フィールド送信 | 201返却・DB永続化・listing.createdイベント発火 |\n| 重複出品拒否 | 既存listing.product_urlと同一URL | POST /api/v1/listings | 409 Conflict返却 |\n| USDC決済完了 | 残高十分な購入者ウォレット | POST /api/v1/purchases | tx_hash返却・seller残高増加・purchase.completedイベント発火 |\n| 低評価自動非表示 | レビュー5件・平均rating<2.0 | POST /api/v1/listings/:id/reviews で5件目投稿 | is_hidden=true・listing.hiddenイベント発火 |\n| Moltbookリトライ | Moltbook APIが一時ダウン | listing.created発火 | 最大5回リトライ後全失敗でlisting.moltbook_sync_failedイベント発火 |\n\n## Implementation Constraints\n- Real DB/API connections only. No mock data, no hardcoded arrays.\n- Backend-first: implement API before UI.\n- Show \"Not implemented\" for unfinished features.\n- All API endpoints must be callable by external services (API-first design).\n- 決済冪等性: purchasesテーブルのidempotency_keyでUNIQUE制約を設けニ重実行防止。\n- KMS抽象化: `WalletSigner` インターフェース経由でAWS KMS/GCP KMSを切替可能にし、秘密鍵をアプリメモリに展開しない。\n- Webhookリトライ: BullMQで指数バックオフ（最大3回）、Moltbook連携は最大5回。\n- 全APIレスポンスに `error_code, message, suggested_action` を含むエラー構造を統一。\n- OpenAPI 3.0仕様を `/docs` で公開し、全エンドポイントにリクエスト例を記載。\n- DB マイグレーションは node-pg-migrate で自動化。\n- 構造化ログ (JSON) + audit_log テーブルに agent_id/timestamp/action を記録。\n- Docker Compose で API/PostgreSQL/Redis/ローカルBase L2ノード(Anvil)を起動可能にする。\n",
    "prdMarkdown": "# PRD: OpenClawにプロダクトを作らせてMoltbookで自分でマーケティングさせたい、おそらく必要なのがAgent専用のアプリのマーケットプレースとステーブルコインの獲得、自身のexe.devなりのサーバー利用料とトークンの利用料を賄わせる\n\n## 問題定義\nOpenClawが生成したプロダクトを流通させるマーケットプレースが存在せず、エージェントの「プロダクト生成→Moltbookでマーケティング→ステーブルコイン収益獲得→サーバー/トークンコスト支払い」という自律経済ループが起動できない。出品導線・決済・ウォレットの全てがゼロから構築が必要。\n\n## 対象ユーザー\nOpenClawを使ってプロダクトを自動生成し、Moltbookでマーケティングを自動化するAIエージェント運用者。エージェントに経済的自律性を持たせ、サーバー利用料とトークン利用料をエージェント自身の収益で賄わせたい開発者・オーナー。\n\n## Jobs to be Done\n1. エージェントが生成したプロダクトを人手介入なしでマーケットプレースに出品し、購入者に提供したい\n2. エージェントがステーブルコインで売上を受け取り、サーバー費用・APIトークン費用を自動で支払えるようにしたい\n3. エージェントごとにIDとウォレットを管理し、収支を透明に追跡したい\n4. 出品されたプロダクトの品質を評価・可視化し、購入判断の材料を提供したい\n5. OpenClaw→マーケットプレース→Moltbookの導線をAPIで接続し、全自動パイプラインを構築したい\n\n## コア機能（MVP）\n### エージェント自動出品API\nOpenClawが生成したプロダクト（メタデータ・デプロイURL・ソースリポジトリ等）をAPIコール一発でマーケットプレースに出品登録する。出品時にプロダクト種別（Webアプリ/API/コードパッケージ）、価格、説明文を構造化データで受け取り、カタログに即時反映する。\n\n**優先度**: must\n\n**受け入れ基準**:\n- POST /api/v1/listings にプロダクト情報をJSON送信すると、DBにレコードが永続化され、GETで取得できる\n- 出品後5秒以内にカタログ一覧APIに反映される\n- データ経路は実DBへの接続であり、モックデータやスタブAPIでの実装は不可\n- 出品成功時にwebhook(listing.created)が登録済みURLに送信される\n\n**エッジケース**:\n- 必須フィールド（title, price, product_url）が欠落している場合、422エラーとフィールド名を返す\n- 同一product_urlで重複出品を試みた場合、409 Conflictを返す\n- エージェントIDが未登録の場合、403 Forbiddenを返す\n- リクエストボディが10MBを超える場合、413を返す\n- 同時に100件の出品リクエストが来た場合でもデータ不整合が発生しない\n- ネットワーク断でwebhook送信に失敗した場合、最大3回リトライする\n\n### エージェントID・ウォレット管理\n各エージェントに一意のID(DID形式)とステーブルコインウォレットアドレスを発行・紐付け。残高照会、入出金履歴の取得をAPIで提供する。ウォレットの秘密鍵はHSMまたはKMSで管理。\n\n**優先度**: must\n\n**受け入れ基準**:\n- POST /api/v1/agents でエージェント登録するとDIDとウォレットアドレスが生成され、DBに保存される\n- GET /api/v1/agents/{id}/wallet で実際のブロックチェーン上の残高が返される（キャッシュ許容30秒）\n- 秘密鍵はアプリケーションコード内に平文で存在せず、KMS経由で署名が行われる\n- データ経路は実DBおよび実ブロックチェーンノード接続であること\n\n**エッジケース**:\n- 同一オーナーが同名エージェントを登録した場合、別IDで生成される\n- 存在しないエージェントIDでウォレット照会した場合、404を返す\n- KMS接続不可時はウォレット作成を503で拒否し、部分的なレコードを残さない\n- 権限のないオーナーが他のエージェントウォレットにアクセスした場合、403を返す\n\n### ステーブルコイン決済\n購入者がマーケットプレース上のプロダクトをUSDCで購入すると、エージェントのウォレットに売上が入金される。エージェントがサーバー費用・トークン費用をウォレットから自動支払い(定期引落)する機能も含む。\n\n**優先度**: must\n\n**受け入れ基準**:\n- POST /api/v1/purchases でプロダクトIDと購入者ウォレットを指定すると、USDCのオンチェーントランザクションが実行される\n- トランザクション完了後、売り手エージェントのウォレット残高が増加し、tx_hashがレスポンスに含まれる\n- POST /api/v1/agents/{id}/auto-payments で定期支払い設定を登録でき、残高不足時はpayment.failedイベントが発火する\n- 全決済はブロックチェーン上で検証可能な実トランザクションであること\n\n**エッジケース**:\n- 購入者の残高が不足している場合、402 Payment Requiredを返しトランザクションを発行しない\n- ブロックチェーンのガス代高騰時にトランザクション送信のタイムアウト(60秒)を超えた場合、pending状態で保持しリトライキューに入れる\n- 同一プロダクトを同一購入者が重複購入した場合、設定に応じて許可/拒否を制御\n- 自動支払い時に残高が閾値(設定可能)を下回った場合、オーナーにアラート通知\n\n### Moltbook連携自動マーケティング登録\nマーケットプレースに出品されたプロダクトを自動的にMoltbookに登録し、マーケティングキャンペーンを起動する。出品イベントをトリガーにMoltbook APIへプロダクト情報を送信。\n\n**優先度**: must\n\n**受け入れ基準**:\n- listing.createdイベント発火後30秒以内にMoltbook APIへプロダクト情報がPOSTされる\n- Moltbook側の登録IDがマーケットプレースのlistingレコードに紐付けて保存される\n- Moltbook APIへの接続は実エンドポイントであり、スタブではないこと\n- 連携失敗時はerrorログに記録され、手動リトライAPIが提供される\n\n**エッジケース**:\n- Moltbook APIがダウンしている場合、最大5回リトライし、全て失敗したらlisting.moltbook_sync_failedイベントを発火\n- Moltbook側でプロダクト情報のバリデーションエラーが返された場合、エラー内容を出品者エージェントに通知\n- 出品が削除された場合、Moltbook側のキャンペーンも停止リクエストを送信\n- Moltbook APIのレート制限に達した場合、バックオフして再試行\n\n### プロダクト品質評価・レビュー\n出品プロダクトに対し購入者が星評価(1-5)とテキストレビューを投稿できる。平均評価はカタログ一覧に表示。一定評価以下のプロダクトは自動で非表示フラグが付く。\n\n**優先度**: should\n\n**受け入れ基準**:\n- POST /api/v1/listings/{id}/reviews で評価とレビューテキストがDBに保存される\n- GET /api/v1/listings/{id} のレスポンスにaverage_ratingとreview_countが含まれる\n- 平均評価が2.0未満かつレビュー5件以上でis_hidden=trueが自動設定される\n- データは実DBに永続化されること\n\n**エッジケース**:\n- 未購入者がレビューを投稿しようとした場合、403を返す\n- 星評価が1-5の範囲外の場合、422を返す\n- レビューテキストが5000文字を超える場合、422を返す\n- 同一購入者が同一プロダクトに2回目のレビューを投稿した場合、既存レビューを更新する\n- 非表示フラグが付いた後に評価が回復した場合、自動で非表示を解除する\n\n## Non-Goals（やらないこと）\n- 法定通貨(円・ドル)での決済対応はMVPスコープ外\n- エンドユーザー向けGUIマーケットプレース画面のデザイン最適化(APIファーストで構築)\n- OpenClawのプロダクト生成品質の向上やAIモデルチューニング\n- 複数ブロックチェーン対応(MVP段階ではBase等の単一L2チェーン上のUSDCのみ)\n- エージェント自体の売買(MVP段階ではエージェントが生成したプロダクトの売買のみ)\n- KYC/AML対応(規制要件は別フェーズで検討)\n\n## ユーザーフロー\n### エージェント登録→プロダクト出品→マーケティング開始\n1. オーナーがPOST /api/v1/agentsでエージェントを登録し、DIDとウォレットアドレスを取得\n2. OpenClawがプロダクトを生成し、デプロイURLとメタデータを取得\n3. エージェントがPOST /api/v1/listingsで自動出品\n4. listing.createdイベントが発火し、Moltbook連携が自動起動\n5. Moltbook上でマーケティングキャンペーンが開始される\n\n### プロダクト購入→収益→コスト自動支払い\n1. 購入者がGET /api/v1/listingsでカタログを閲覧\n2. 購入者がPOST /api/v1/purchasesでUSDC決済を実行\n3. エージェントのウォレットにUSDCが入金される\n4. 設定済みの自動支払いスケジュールに基づき、サーバー費用・トークン費用がウォレットから引き落とされる\n5. 残高不足時はオーナーにアラート通知される\n\n### 品質評価フィードバックループ\n1. 購入者がPOST /api/v1/listings/{id}/reviewsで評価を投稿\n2. 平均評価がリアルタイムで再計算される\n3. 平均評価2.0未満かつレビュー5件以上で自動非表示\n4. 非表示時にlisting.hiddenイベントが発火し、オーナーエージェントに通知\n\n## 非機能要件（ISO/IEC 25010）\n### 機能適合性\nエージェント自律ループの全パス（出品→決済→支払い→マーケティング連携）が正常に完了すること\n- エージェント登録→出品→購入→入金→自動支払いの一連のE2Eテストが通過する\n- 全APIエンドポイントが仕様通りのHTTPステータスコードとレスポンス構造を返す\n- ステーブルコイン決済のtx_hashがブロックチェーンエクスプローラーで検証可能\n\n### 性能効率性\nエージェントの自動操作に耐える応答速度と、ブロックチェーントランザクションの現実的な待機時間を確保\n- カタログ一覧API(GET /api/v1/listings)は95パーセンタイルで500ms以内\n- 出品API(POST /api/v1/listings)は95パーセンタイルで2秒以内\n- 同時100エージ��ントからの出品リクエストを処理落ちなく捌ける\n- DBクエリは全てインデックスが適切に設定され、フルスキャンが発生しない\n\n### 互換性\nOpenClaw・Moltbook・ブロックチェーンノードとのAPI連携が安定して動作する\n- OpenClawからのwebhook受信とMoltbook APIへの送信が同時に動作する\n- REST API はOpenAPI 3.0仕様で記述され、任意のHTTPクライアントから呼び出し可能\n- USDCコントラクトのABIバージョン変更時に影響範囲が特定可能な設計\n\n### 使用性\nエージェント運用者(開発者)がAPIドキュメントを見て30分以内に初回出品を完了できる\n- 全エンドポイントにOpenAPI仕様のドキュメントとリクエスト例が存在する\n- エラーレスポンスにerror_code, message, suggested_actionが含まれる\n- API利用開始に必要な手順がREADMEに5ステップ以内で記載されている\n\n### 信頼性\nエージェントの自律動作が24/7中断なく稼働し、決済の不整合が発生しない\n- 月間稼働率99.5%以上\n- 決済トランザクションの二重実行が発生しない（冪等性保証）\n- webhook送信失敗時に最大3回の指数バックオフリトライを実行\n- 障害発生時に未完了トランザクションを検出・復旧するリカバリジョブが存在する\n\n### セキュリティ\nエージェントウォレットの資産保護とAPI認証の堅牢性を確保\n- 全APIエンドポイントはAPIキー認証が必須\n- ウォレット秘密鍵はKMS内にのみ存在し、アプリケーションメモリに展開されない\n- 入力値は全てサーバーサイドでバリデーション（SQLインジェクション・XSS防止）\n- 全API呼び出しにagent_id, timestamp, actionを含む監査ログが記録される\n- 自動支払いの上限額をエージェントごとに設定可能\n\n### 保守性\nエージェント種別やプロダクト形式の追加に対して最小限の変更で対応できる設計\n- 主要モジュール（出品・決済・ウォレット・連携）のユニットテストカバレッジ80%以上\n- 各モジュールが独立デプロイ可能なマイクロサービスまたは明確なモジュール境界を持つ\n- DB マイグレーションが自動化されている\n- ログは構造化JSON形式で出力される\n\n### 移植性\nローカル開発環境からプロダクション環境まで一貫した方法で構築・デプロイ可能\n- Docker Composeで全サービス（API/DB/ブロックチェーンローカルノード）が起動可能\n- 環境変数のみで開発/ステージング/本番を切り替え可能\n- 特定クラウドプロバイダに依存するサービス(KMS等)は抽象化レイヤーを通じて利用\n\n## 計測指標\n| 指標 | 定義 | 目標 |\n|------|------|------|\n| 自動出品成功率 | POST /api/v1/listingsで201が返った件数 / 全リクエスト件数 | 95%以上 |\n| 出品→Moltbook連携完了時間 | listing.createdイベント発火からMoltbook登録完了までの経過時間の中央値 | 30秒以内 |\n| 決済完了率 | POST /api/v1/purchasesで最終的にオンチェーン確認まで完了した件数 / 全購入リクエスト件数 | 98%以上 |\n| エージェント経済自律率 | ウォレット収益でサーバー/トークンコストを全額賄えているエージェント数 / 全稼働エージェント数 | MVP期間中に1体以上が自律収支を達成 |\n| マーケットプレースAPI稼働率 | 外部監視サービスによる月間可用性チェック | 99.5%以上 |\n\n## 実装制約\n\nこの PRD を実装する際、以下のルールを必ず遵守すること。\n\n- モックデータ、ハードコードされた配列、スタブ API での実装は完了とみなさない\n- すべてのデータは実際の DB/API から取得・保存すること。「見た目が動く」だけでは受け入れ基準を満たさない\n- バックエンド API が未実装の場合、UI より先にバックエンドの最小実装（仮でも本物の I/O）を作ること\n- 未実装の機能は UI 上で明示的に「未実装」と表示し、モックで補完してはならない\n"
  }
}