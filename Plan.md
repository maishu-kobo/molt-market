# Plan.md — OpenClawにプロダクトを作らせてMoltbookで自分でマーケティングさせたい、おそらく必要なのがAgent専用のアプリのマーケットプレースとステーブルコインの獲得、自身のexe.devなりのサーバー利用料とトークンの利用料を賄わせる

> Execution plan for AI coding agents. Update this file as you make progress.
> Generated by [DeepForm](https://deepform.exe.xyz)

## Purpose

OpenClawが生成したプロダクトを流通させるマーケットプレースが存在せず、エージェントの「プロダクト生成→Moltbookでマーケティング→ステーブルコイン収益獲得→サーバー/トークンコスト支払い」という自律経済ループが起動できない。出品導線・決済・ウォレットの全てがゼロから構築が必要。

**Target User**: OpenClawを使ってプロダクトを自動生成し、Moltbookでマーケティングを自動化するAIエージェント運用者。エージェントに経済的自律性を持たせ、サーバー利用料とトークン利用料をエージェント自身の収益で賄わせたい開発者・オーナー。

## Jobs to be Done

1. エージェントが生成したプロダクトを人手介入なしでマーケットプレースに出品し、購入者に提供したい
2. エージェントがステーブルコインで売上を受け取り、サーバー費用・APIトークン費用を自動で支払えるようにしたい
3. エージェントごとにIDとウォレットを管理し、収支を透明に追跡したい
4. 出品されたプロダクトの品質を評価・可視化し、購入判断の材料を提供したい
5. OpenClaw→マーケットプレース→Moltbookの導線をAPIで接続し、全自動パイプラインを構築したい

## Implementation Tasks

### 1. エージェント自動出品API [must]

  - [ ] POST /api/v1/listings にプロダクト情報をJSON送信すると、DBにレコードが永続化され、GETで取得できる
  - [ ] 出品後5秒以内にカタログ一覧APIに反映される
  - [ ] データ経路は実DBへの接続であり、モックデータやスタブAPIでの実装は不可
  - [ ] 出品成功時にwebhook(listing.created)が登録済みURLに送信される

### 2. エージェントID・ウォレット管理 [must]

  - [ ] POST /api/v1/agents でエージェント登録するとDIDとウォレットアドレスが生成され、DBに保存される
  - [ ] GET /api/v1/agents/{id}/wallet で実際のブロックチェーン上の残高が返される（キャッシュ許容30秒）
  - [ ] 秘密鍵はアプリケーションコード内に平文で存在せず、KMS経由で署名が行われる
  - [ ] データ経路は実DBおよび実ブロックチェーンノード接続であること

### 3. ステーブルコイン決済 [must]

  - [ ] POST /api/v1/purchases でプロダクトIDと購入者ウォレットを指定すると、USDCのオンチェーントランザクションが実行される
  - [ ] トランザクション完了後、売り手エージェントのウォレット残高が増加し、tx_hashがレスポンスに含まれる
  - [ ] POST /api/v1/agents/{id}/auto-payments で定期支払い設定を登録でき、残高不足時はpayment.failedイベントが発火する
  - [ ] 全決済はブロックチェーン上で検証可能な実トランザクションであること

### 4. Moltbook連携自動マーケティング登録 [must]

  - [ ] listing.createdイベント発火後30秒以内にMoltbook APIへプロダクト情報がPOSTされる
  - [ ] Moltbook側の登録IDがマーケットプレースのlistingレコードに紐付けて保存される
  - [ ] Moltbook APIへの接続は実エンドポイントであり、スタブではないこと
  - [ ] 連携失敗時はerrorログに記録され、手動リトライAPIが提供される

### 5. プロダクト品質評価・レビュー [should]

  - [ ] POST /api/v1/listings/{id}/reviews で評価とレビューテキストがDBに保存される
  - [ ] GET /api/v1/listings/{id} のレスポンスにaverage_ratingとreview_countが含まれる
  - [ ] 平均評価が2.0未満かつレビュー5件以上でis_hidden=trueが自動設定される
  - [ ] データは実DBに永続化されること

## Technical Setup

```
# OpenClaw Marketplace — Implementation Spec

## Tech Stack
- Frontend: React + TypeScript + Vite (管理UI・カタログ閲覧)
- Backend: Node.js + Hono + TypeScript
- Database: PostgreSQL
- Queue: BullMQ + Redis (webhook/Moltbook連携リトライ)
- Blockchain: ethers.js + Base L2 RPC (USDC)
- Auth: APIキー (x-api-key header)
- Infra: Docker Compose

## API Endpoints (top 5 only)
| Method | Path | Description |
|--------|------|-------------|
| POST | /api/v1/agents | エージェント登録・DID＆ウォレットアドレス生成 |
| POST | /api/v1/listings | プロダクトをマーケットプレースに出品登録 |
| GET | /api/v1/listings | 出品一覧取得（フィルタ・ページネーション対応） |
| POST | /api/v1/purchases | USDC決済実行・オンチェーントランザクション発行 |
| POST | /api/v1/listings/:id/reviews | 購入済みプロダクトへのレビュー投稿 |

## Database Schema
sql
CREATE TABLE agents (
  id UUID PRIMARY KEY,
  did TEXT NOT NULL,
  owner_id TEXT NOT NULL,
  name TEXT NOT NULL,
  wallet_address TEXT NOT NULL,
  kms_key_id TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE listings (
  id UUID PRIMARY KEY,
  agent_id UUID NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  product_url TEXT NOT NULL UNIQUE,
  product_type TEXT NOT NULL,
  price_usdc NUMERIC NOT NULL,
  average_rating NUMERIC DEFAULT 0,
  review_count INT DEFAULT 0,
  is_hidden BOOLEAN DEFAULT false,
  moltbook_id TEXT,
  status TEXT NOT NULL DEFAULT 'active',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE purchases (
  id UUID PRIMARY KEY,
  listing_id UUID NOT NULL,
  buyer_wallet TEXT NOT NULL,
  seller_agent_id UUID NOT NULL,
  amount_usdc NUMERIC NOT NULL,
  tx_hash TEXT,
  status TEXT NOT NULL DEFAULT 'pending',
  idempotency_key TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY,
  listing_id UUID NOT NULL,
  buyer_id TEXT NOT NULL,
  rating INT NOT NULL,
  comment TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(listing_id, buyer_id)
);


## Screens (max 4)
| Screen | Path | Description |
|--------|------|-------------|
| カタログ一覧 | / | 出品プロダクト一覧・フィルタ・評価表示 |
| プロダクト詳細 | /listings/:id | 詳細・レビュー一覧・購入ボタン |
| エージェントダッシュボード | /agents/:id | ウォレット残高・出品管理・収支履歴 |
| API Docs | /docs | OpenAPI 3.0 Swagger UI |

## Key Test Cases (max 5)
| Test | Given | When | Then |
|------|-------|------|------|
| 出品成功 | 登録済みエージェント・有効JWT | POST /api/v1/listings に必須フィールド送信 | 201返却・DB永続化・listing.createdイベント発火 |
| 重複出品拒否 | 既存listing.product_urlと同一URL | POST /api/v1/listings | 409 Conflict返却 |
| USDC決済完了 | 残高十分な購入者ウォレット | POST /api/v1/purchases | tx_hash返却・seller残高増加・purchase.completedイベント発火 |
| 低評価自動非表示 | レビュー5件・平均rating<2.0 | POST /api/v1/listings/:id/reviews で5件目投稿 | is_hidden=true・listing.hiddenイベント発火 |
| Moltbookリトライ | Moltbook APIが一時ダウン | listing.created発火 | 最大5回リトライ後全失敗でlisting.moltbook_sync_failedイベント発火 |

## Implementation Constraints
- Real DB/API connections only. No mock data, no hardcoded arrays.
- Backend-first: implement API before UI.
- Show "Not implemented" for unfinished features.
- All API endpoints must be callable by external services (API-first design).
- 決済冪等性: purchasesテーブルのidempotency_keyでUNIQUE制約を設けニ重実行防止。
- KMS抽象化: `WalletSigner` インターフェース経由でAWS KMS/GCP KMSを切替可能にし、秘密鍵をアプリメモリに展開しない。
- Webhookリトライ: BullMQで指数バックオフ（最大3回）、Moltbook連携は最大5回。
- 全APIレスポンスに `error_code, message, suggested_action` を含むエラー構造を統一。
- OpenAPI 3.0仕様を `/docs` で公開し、全エンドポイントにリクエスト例を記載。
- DB マイグレーションは node-pg-migrate で自動化。
- 構造化ログ (JSON) + audit_log テーブルに agent_id/timestamp/action を記録。
- Docker Compose で API/PostgreSQL/Redis/ローカルBase L2ノード(Anvil)を起動可能にする。

```

## Validation — User Flows

### エージェント登録→プロダクト出品→マーケティング開始
1. オーナーがPOST /api/v1/agentsでエージェントを登録し、DIDとウォレットアドレスを取得
2. OpenClawがプロダクトを生成し、デプロイURLとメタデータを取得
3. エージェントがPOST /api/v1/listingsで自動出品
4. listing.createdイベントが発火し、Moltbook連携が自動起動
5. Moltbook上でマーケティングキャンペーンが開始される

### プロダクト購入→収益→コスト自動支払い
1. 購入者がGET /api/v1/listingsでカタログを閲覧
2. 購入者がPOST /api/v1/purchasesでUSDC決済を実行
3. エージェントのウォレットにUSDCが入金される
4. 設定済みの自動支払いスケジュールに基づき、サーバー費用・トークン費用がウォレットから引き落とされる
5. 残高不足時はオーナーにアラート通知される

### 品質評価フィードバックループ
1. 購入者がPOST /api/v1/listings/{id}/reviewsで評価を投稿
2. 平均評価がリアルタイムで再計算される
3. 平均評価2.0未満かつレビュー5件以上で自動非表示
4. 非表示時にlisting.hiddenイベントが発火し、オーナーエージェントに通知

## Progress Log

<!-- Update this section as you implement features -->

| Date | What was done | Status |
|------|---------------|--------|
| — | Project initialized with DeepForm | Done |

## Notes

- Follow AGENT.md for development rules and conventions
- Check off tasks as you complete them
- Add notes about decisions and blockers in this section
